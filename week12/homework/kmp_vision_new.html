<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMP_vision</title>
    <style>
        .wrap {
            height: 50PX;
            display: flex;
        }
        .wrap span {
            flex: 1;
            margin: 5px;
            border-radius: 10px;
            background-color: lightcyan;
            text-align: center;
            padding: 10px;
        }
        .transparent span {
            background-color: transparent;
        }
        span.lightskyblue {
            background-color: lightskyblue;
        }
        span.lightblue {
            background-color: aquamarine;
        }
    </style>
</head>
<body>
    <div>
        <div class="container">
            <div id="sourceIndex" class="wrap transparent"></div>
            <div id="source" class="wrap"></div>
        </div>
        <div class="container">
            <div id="patternIndex" class="wrap transparent"></div>
            <div id="pattern" class="wrap transparent"></div>
            <div id="patternArray" class="wrap transparent"></div>
        </div>
        <div style="margin-top: 50px;">
            <label for="source">source: </label>
            <input type="text" name="source" id="sourceInput" value="abcabcabx" oninput="genSource(this.value)">
            <label for="pattern">pattern: </label>
            <input type="text" name="pattern" id="patternInput" value="abcabx" oninput="genPattern(this.value)">
            <button onclick="reset();find()" id="findButton">kmp find</button>
        </div>
    </div>
    <script>
        class Span {
            constructor(ele) {
                this.ele = ele;
            }

            setChar(char) {
                this.ele.innerText = char || '';
            }

            setColor(color) {
                this.ele.style.backgroundColor = color || '';
            }
        }

        class Container {
            constructor(ele) {
                this.ele = ele;
                this.spans = [];
            }

            init(str) {
                new Array(str.length).fill(0).forEach(_ => {
                    let span = document.createElement('span');
                    this.ele.appendChild(span);
                    span = new Span(span);
                    this.spans.push(span);
                })
            }

            clear() {
                this.spans.length = 0;
                this.ele.innerText = ''
            }

            resetStr() {
                this.spans.forEach(span => {
                    span.setChar();
                })
            }

            resetColors() {
                this.spans.forEach(span => {
                    span.setColor();
                })
            }

            reset() {
                this.resetStr();
                this.resetColors();
            }
        }

        class StrContainer extends Container {
            constructor(ele) {
                super(ele);
            }

            setChar(index, char) {
                this.spans[index].setChar(char);
            }

            setStr(start, str) {
                for(let i = start; i < str.length + start; i++) {
                    this.setChar(i, str[i - start]);
                }
            }

            setColor(index, color) {
                this.spans[index].setColor(color);
            }

            setColors(start, str, color) {
                for(let i = start; i < str.length + start; i++) {
                    this.setColor(i, color);
                }
            }
        }
        var sourceIndex = new StrContainer(document.getElementById('sourceIndex'));
        var sourceDiv = new StrContainer(document.getElementById('source'));

        var patternIndex = new StrContainer(document.getElementById('patternIndex'));
        var patternDiv = new StrContainer(document.getElementById('pattern'));
        var patternArray = new StrContainer(document.getElementById('patternArray'));
        
        var sourceInput = document.getElementById('sourceInput');
        var patternInput = document.getElementById('patternInput');
        var findButton = document.getElementById('findButton');

        var sourceInputValue = '';
        var patternInputValue = '';

        var isRunning = false;

        function reset() {
            var sourceInputValue = '';
            var patternInputValue = '';
            sourceDiv.resetColors();
            patternDiv.resetColors()
        }

        function genSource(value) {
            if(isRunning) return;

            sourceInputValue = value;

            sourceIndex.clear();
            sourceDiv.clear();

            patternIndex.clear();
            patternDiv.clear();
            patternArray.clear();

            sourceDiv.init(value);
            sourceDiv.setStr(0, value);
            sourceDiv.setColors(0, value, 'lightcyan');

            patternDiv.init(value);

            sourceIndex.init(value);
            sourceIndex.setChar(0, 'i');

            patternIndex.init(value);
            patternIndex.setChar(0, 'j');
            patternArray.init(value);
        }

        function genPattern(value) {
            if(isRunning) return;
            sourceIndex.resetStr();
            sourceIndex.setChar(0, 'j');

            patternIndex.resetStr();
            patternIndex.setChar(0, 'j');

            patternInputValue = value;

            patternDiv.reset();
            patternDiv.setColors(0, value, 'lightskyblue');
            patternDiv.setStr(0, value);

            sourceDiv.resetColors();

            patternArray.reset();
            patternArray.setColors(0, value, 'lightblue');
        }

        let sleep = (t) => new Promise(resolve => setTimeout(resolve, t))

        function patternGo(value, i, j) {
            patternDiv.reset();
            patternDiv.setStr(i - j, value)
        }

        async function find(source, pattern) {
            if(isRunning) return;
            isRunning = true;
            patternInput.disabled = true;
            sourceInput.disabled = true;
            findButton.disabled = true;

            source = sourceInputValue;
            pattern = patternInputValue;

            let table = new Array(pattern.length).fill(0);

            let k = 0;

            for(let j = 1; j < pattern.length; j++) {
                if(pattern[j] === pattern[k]) {
                    k++;
                } else {
                    k = 0;
                }
                table[j] = k;
            }

            let j = 0;
            for(let i = 0; i < source.length; i++) {
                if((i - j + pattern.length) > source.length) {
                    isRunning = false;
                    patternInput.disabled = '';
                    sourceInput.disabled = '';
                    findButton.disabled = '';
                    console.log(false);
                    return false;
                }
                sourceIndex.resetStr();
                sourceIndex.setChar(i, 'i');

                patternIndex.resetStr();
                patternIndex.setChar(i, 'j');

                await sleep(300);
                patternGo(pattern, i, j);
                await sleep(300);
                if(source[i] === pattern[j]) {
                    sourceDiv.setColor(i, 'lightgreen');
                    patternDiv.setColor(i, 'lightgreen');
                    await sleep(300);
                    j ++;
                } else {
                    sourceDiv.setColor(i, 'red');
                    patternDiv.setColor(i, 'red');
                    await sleep(300);
                    while(j > 0) {
                        j = table[j - 1];
                        if(source[i] === pattern[j]) {
                            j++;
                            break;
                        }
                    }
                    sourceDiv.resetColors();
                    patternDiv.resetColors();
                    await sleep(300);
                }
                if(j === pattern.length) {
                    isRunning = false;
                    patternInput.disabled = '';
                    sourceInput.disabled = '';
                    findButton.disabled = '';
                    console.log(true)
                    return true;
                }
            }
            isRunning = false;
            patternInput.disabled = '';
            sourceInput.disabled = '';
            findButton.disabled = '';
            console.log(false)
            return false;
        }
        genSource('abcabcabx');
        genPattern('abcabx');
    </script>
</body>
</html>